---
layout: post
title: "Auto download lecture videos from rvc.ust.hk"
date: 2016-09-29 06:24
tags: 
    - web
    - python
categories: 
    - web
    - python
thumbnail: bug
description: A script written by python to download lecture videos from rvc.ust.hk.
---

## 0. 又一个脚本

前两天看了一个说法，说计算机和互联网虽然大家都在用，但是还没有真正普及。大家都是在使用，没有在利用，利用计算机和互联网为自己行使便利的平均能力太低。

比如，抢不到票就写个脚本自动抢票，这个行为，在很多普通人（非程序员）看来就是作弊，是不利于社会公平的行为；但是在程序员看来，他利用了自己的知识（会写程序）并且付出了劳动（写脚本也需要时间），就应该得到应得的结果，这样才是公平。

有人提出，问题的本身在于普通人并不认为自己需要会写程序，并且潜意识里面认为自己根本不能学会写程序。

这一点上我深感认同。其实我感觉写程序并不是很难的一件事，但是写出出色的程序是很难的。但是在编程工具繁多的现在，能写出辅助自己生活的，能运行的，但不一定运行得像生产环境中一样高效的代码并不是一件很难的事，只要理解程序运行的逻辑就很容易。

其实自认为对于初学者来说，程序运行的逻辑就是，你让它干什么它才会干什么。我们需要做的事情就是把一个要让计算机完成的事件分解成一部分一部分的。

对于面向对象编程来说，就把事件看成几个东西的组合，这几个东西是构造出来整个事件的砖头，看看每个砖头的都能有什么功能，把各个功能分别写出来就好。对于每个功能来说，越单一越好。

对于面向过程编程来说，就把事件看成一些步骤，一步一步地做，一步一步地写就好了。

我想这里面最难的事情，就是分解了吧。至于怎么分解，还是要熟悉计算机的逻辑，虽然很多人觉得不好理解，但是我倒是觉得比人类的逻辑直接明了多了。

说了这么多，都跑题了。很久以前就不爽学校录制的教学视频的网页了，太不方便，所以就想着什么时候写个脚本给视频扒下来。刚好看到之前那个说法，说不会利用计算机和互联网使自己生活变得更方便的人就属于没有普及的人群。我就自己反思了一下，感觉自己一直都在用别人的劳动成果而没有自己的东西，平时突然想到的倒是挺多，就是全都没有实现。所以就想着把自己的想法都一个一个实现了。

超有成就感的，哈哈。

## 1. 网站登录

首先遇到的问题就是，要进入视频页面，就一定要登录学校的系统。我抓了一下登录页面，感觉没什么坑，也没有验证码什么的，表单也很简单，感觉用`requests`库的话应该几行就可以。

但是，不管我怎么发送表单，怎么修改`headers`，就是登录不了，也不知道是什么原因，最后实在没办法，想起来了一个神器，就是[selenium](https://github.com/SeleniumHQ/selenium)，之前用过的，模拟鼠标点击和键盘输入，果然很容易就好了。

但是，还是好希望能直接用`requests`库来登录，感觉能轻量级很多。

## 2. 观察视频抓取方式

进去视频页面之后，先利用`Chrome`和`Firefox`的开发者工具箱查看它是怎么抓取视频的。

本来以为像学校这么。。的地方肯定就只是简单的从数据库抽取视频放在网页上就好了，我只需要找到一个类似`.mp4`的文件，然后就可以get到了。

但是发现学校竟然是用**RTSP**流媒体传输协议来传输视频的，把视频分成9.6秒的块，分块拉取的。我都差点准备写个`RTSP`客户端了，但是冷静下来，觉得不应该是这么麻烦的办法。再仔细研究网站的视频流获取方式，发现还是有用`http`协议传输的，那就简单多了，可以直接抓。整个关键的过程分为三步：

1. 向服务器申请获取一个`playlist.m3u8`文件，这个文件里面包含了下一步需要的`chunklist`文件后面跟的cookie序号和session的ID，因此获得了这个文件就可以直接生成获取`chunklist`的网址，不需要重新登录；

2. 根据上面生成的网址向服务器申请获取一个`chunklist_cookie.m3u8`文件，这个文件包含了所有的视频块的地址的关键部分，可以直接生成能获取视频块的地址；

3. 根据`chunklist`文件中的`chunk`部分，向服务器请求获取每个`chunk`部分，这个就是需要的视频文件。

## 3. 合并视频块

下载下来的视频块有一千多个，每个都是9.6秒的，大概1MB大小，还是不方便，还是要合并。

查找资料发现，刚好视频流是`.ts`格式的，可以直接追加，这样就方便了。

- windows 下的命令：`copy /b video1 + video2 video`

- Linux 下的命令：`cat video1 video2 > video`

可以直接用python里的`os.system(cmd)`就可以调用了。

这里面有一个坑，就是python对于字符串是有个默认排序的，排出来是这样的：‘1’，‘10’，‘11’，...，‘2’，‘20’，‘21’，...

但是服务器过来的数据是按照数字顺序（1，2，3，...）排序的，所以还是要重新处理一下。

源码在[这里](https://github.com/firiceguo/Auto-download-rvc.ust.hk)
